<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Oilan AI</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body class="bg-light">
        <div class="container mt-5">
            <div class="text-center">
                <h1 class="display-4">Welcome to Oilan</h1>
                <p class="lead">Your guide to self-healing through dialogue.</p>
                <hr>
            </div>

            <div id="auth-section" class="text-center">
                <p>Please log in to begin your session.</p>
                <a href="/auth/google" class="btn btn-primary btn-lg">Login with Google</a>
            </div>

            <div id="chat-section" class="d-none">
                <h3 id="welcome-message"></h3>
                <div id="chat-window" class="card" style="height: 400px; overflow-y: scroll;">
                    <div class="card-body">
                        </div>
                </div>
                <div class="input-group mt-3">
                    <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
                    <button id="send-button" class="btn btn-success">Send</button>
                </div>
                <button id="new-chat-button" class="btn btn-secondary mt-3">Start New Chat</button>
            </div>
        </div>

        <script>
            // Simple state management
            let jwtToken = null;
            let currentDialogID = null;

            // DOM Elements
            const authSection = document.getElementById('auth-section');
            const chatSection = document.getElementById('chat-section');
            const welcomeMessage = document.getElementById('welcome-message');
            const chatWindowBody = document.querySelector('#chat-window .card-body');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const newChatButton = document.getElementById('new-chat-button');

            function addMessageToWindow(role, content) {
                const alignClass = role === 'user' ? 'text-end' : 'text-start';
                const colorClass = role === 'user' ? 'bg-primary text-white' : 'bg-secondary text-white';
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-2 my-2 rounded ${alignClass}`;
                messageDiv.innerHTML = `<span class="px-2 py-1 rounded ${colorClass}">${content}</span>`;
                chatWindowBody.appendChild(messageDiv);
                chatWindowBody.scrollTop = chatWindowBody.scrollHeight;
            }

            async function apiFetch(endpoint, method, body) {
                const headers = { 'Content-Type': 'application/json' };
                if (jwtToken) {
                    headers['Authorization'] = `Bearer ${jwtToken}`;
                }
                const response = await fetch(endpoint, {
                    method: method,
                    headers: headers,
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }
                return response.json();
            }

            async function startNewChat() {
                try {
                    const dialog = await apiFetch('/api/v1/dialogs', 'POST', { title: 'New Web Chat' });
                    currentDialogID = dialog.id;
                    chatWindowBody.innerHTML = ''; // Clear window
                    addMessageToWindow('ai', 'Hello! How can I help you today?');
                    console.log('Started new chat with ID:', currentDialogID);
                } catch (error) {
                    alert('Error starting new chat: ' + error.message);
                }
            }

            async function sendMessage() {
                const content = messageInput.value.trim();
                if (!content || !currentDialogID) return;
                
                messageInput.disabled = true;
                sendButton.disabled = true;
                addMessageToWindow('user', content);
                messageInput.value = '';

                try {
                    const aiResponse = await apiFetch(`/api/v1/dialogs/${currentDialogID}/messages`, 'POST', { content: content });
                    addMessageToWindow('ai', aiResponse.content);
                } catch (error) {
                    alert('Error sending message: ' + error.message);
                    addMessageToWindow('ai', 'Sorry, I encountered an error.');
                } finally {
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    messageInput.focus();
                }
            }

            // --- On Page Load ---
            document.addEventListener('DOMContentLoaded', () => {
                const params = new URLSearchParams(window.location.search);
                const tokenFromUrl = params.get('token'); // This is how you would get token in real app

                // For this demo, we'll simulate getting the token after the callback
                if (window.location.pathname.includes('/auth/google/callback')) {
                    // This is a simplified simulation. In a real app, the server would handle this.
                    // We are pretending the server gave us a token somehow.
                    const tempTokenData = document.body.innerText;
                    try {
                        const tokenData = JSON.parse(tempTokenData);
                        if(tokenData.token) {
                            localStorage.setItem('oilan_jwt', tokenData.token);
                            window.location.href = '/'; // Redirect to home
                        }
                    } catch(e) {
                        // Ignore parsing errors, it might be the "database error" message
                    }
                }
                
                jwtToken = localStorage.getItem('oilan_jwt');
                
                if (jwtToken) {
                    authSection.classList.add('d-none');
                    chatSection.classList.remove('d-none');
                    welcomeMessage.innerText = "Welcome back!";
                    startNewChat();
                }

                sendButton.addEventListener('click', sendMessage);
                messageInput.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') sendMessage();
                });
                newChatButton.addEventListener('click', startNewChat);
            });

        </script>
    </body>
</html>